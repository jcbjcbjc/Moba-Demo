{"version":3,"sources":["file:///D:/LearningFrameWork/MobaYan/Moba/Src/Client/assets/Scripts/UI/Battle/Models/Buff.ts"],"names":["Buff","NetConfig","DamageInfo","constructor","buffID","owner","define","context","BuffID","Owner","Define","Context","OnAdd","console","log","Effect","EffectMgr","AddEffect","AddAttr","OnRemove","RemoveAttr","Stoped","RemoveEffect","DEFRatio","attributes","DEF","Basic","InitFinalAttributes","LogicUpdate","time","frameTime","Interval","hit","DoBufDamage","Duration","CalcBuffDamage","caster","attFator","ATTFator","final","ATT","damage","entityId","Damage","Math","max","floor","Caster","isBuff","Name","characterDefine","DoDamage"],"mappings":"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","sourcesContent":["import { Creature } from \"../Enities/Creature\";\r\nimport { BuffDefine } from \"../../../Data/BuffDefine\";\r\nimport { BattleContext } from \"./BattleContext\";\r\nimport { BuffEffect } from \"../enums/BuffEffect\";\r\nimport { BuffInfo } from \"../Vo/BuffInfo\";\r\nimport { BuffAction } from \"../enums/BuffAction\";\r\nimport { NetConfig } from \"../../../Network/NetConfig\";\r\nimport { DamageInfo } from \"../Vo/DamageInfo\";\r\n\r\nexport class Buff{\r\n    public BuffID:number;\r\n    private Owner:Creature;\r\n    private Define:BuffDefine;\r\n    private Context:BattleContext;\r\n    private time:number=0;\r\n    private hit:number= 0;;\r\n\r\n    public Stoped:boolean=false;\r\n\r\n    public constructor(buffID:number, owner:Creature, define:BuffDefine, context:BattleContext)\r\n    {\r\n        this.BuffID = buffID;\r\n        this.Owner = owner;\r\n        this.Define = define;\r\n        this.Context = context;\r\n\r\n        this.OnAdd();\r\n    }\r\n\r\n    private OnAdd()\r\n    {\r\n        console.log('Buff OnAdd')\r\n        if(this.Define.Effect)\r\n        {\r\n            this.Owner.EffectMgr.AddEffect(this.Define.Effect);\r\n        }\r\n        this.AddAttr();\r\n\r\n        // let buff = new BuffInfo();\r\n        // buff.buffId=this.BuffID;\r\n        // buff.buffType=this.Define.ID;\r\n        // buff.casterId=this.Context.Caster.entityId;\r\n        // buff.ownerId=this.Owner.entityId\r\n        // buff.Action=BuffAction.Add;\r\n\r\n        // this.Context.Battle.AddBuffAction(buff);\r\n    }\r\n\r\n    private OnRemove()\r\n    {\r\n        console.log('Buff OnRemove')\r\n        this.RemoveAttr();\r\n        this.Stoped = true;\r\n        if (this.Define.Effect)\r\n        {\r\n            this.Owner.EffectMgr.RemoveEffect(this.Define.Effect);\r\n        }\r\n\r\n        // let buff = new BuffInfo();\r\n        // buff.buffId=this.BuffID;\r\n        // buff.buffType=this.Define.ID;\r\n        // buff.casterId=this.Context.Caster.entityId;\r\n        // buff.ownerId=this.Owner.entityId\r\n        // buff.Action=BuffAction.Remove;\r\n\r\n        // this.Context.Battle.AddBuffAction(buff);\r\n    }\r\n\r\n    private AddAttr()\r\n    {\r\n        if (this.Define.DEFRatio)\r\n        {\r\n            this.Owner.attributes.Buff.DEF += this.Owner.attributes.Basic.DEF * this.Define.DEFRatio;\r\n            this.Owner.attributes.InitFinalAttributes();\r\n        }\r\n    }\r\n\r\n    private RemoveAttr()\r\n    {\r\n        if (this.Define.DEFRatio)\r\n        {\r\n            this.Owner.attributes.Buff.DEF -= this.Owner.attributes.Basic.DEF * this.Define.DEFRatio;\r\n            this.Owner.attributes.InitFinalAttributes();\r\n        }\r\n    }\r\n\r\n    public LogicUpdate()\r\n    {\r\n        if (this.Stoped) return;\r\n        this.time += NetConfig.frameTime;   //Time.deltaTime;\r\n        if(this.Define.Interval > 0)\r\n        {//带有间隔时间\r\n            if(this.time > this.Define.Interval * (this.hit + 1))\r\n            {\r\n                this.DoBufDamage();\r\n            }\r\n        }\r\n        if(this.time > this.Define.Duration)\r\n        {\r\n            this.OnRemove();\r\n        }\r\n    }\r\n\r\n    private CalcBuffDamage(caster:Creature):DamageInfo\r\n    {\r\n        let attFator=this.Define.ATTFator; //技能攻击系数\r\n        //计算伤害\r\n        let final = caster.attributes.ATT*attFator*(1-this.Owner.attributes.DEF/(602+this.Owner.attributes.DEF));\r\n\r\n        let damage = new DamageInfo();\r\n        damage.entityId = this.Owner.entityId;\r\n        damage.Damage = Math.max(1, Math.floor(final));\r\n        return damage;\r\n    }\r\n    \r\n    private DoBufDamage()\r\n    {\r\n        this.hit++;\r\n\r\n        let damage = this.CalcBuffDamage(this.Context.Caster);\r\n        damage.isBuff = true;\r\n        console.log(\"Skill[{0}].DoBufDamage[{1}] Damage:{2}\", this.Define.Name, this.Owner.characterDefine.Name, damage.Damage);\r\n        this.Owner.DoDamage(damage, this.Context.Caster);\r\n\r\n        // let buff = new BuffInfo();\r\n        // buff.buffId=this.BuffID;\r\n        // buff.buffType=this.Define.ID;\r\n        // buff.casterId=this.Context.Caster.entityId;\r\n        // buff.ownerId=this.Owner.entityId\r\n        // buff.Action=BuffAction.Hit;\r\n        // buff.damage=damage;\r\n        \r\n        // this.Context.Battle.AddBuffAction(buff);\r\n    }\r\n}"]}