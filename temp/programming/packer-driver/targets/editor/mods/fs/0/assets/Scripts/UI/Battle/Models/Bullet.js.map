{"version":3,"sources":["file:///D:/LearningFrameWork/MobaYan/Moba/Src/Client/assets/Scripts/UI/Battle/Models/Bullet.ts"],"names":["Bullet","NetConfig","CreatureManager","DataManager","LogicRenderConvert","MathUtil","HashMap","EffectType","constructor","skill","target","hitInfo","distance","Define","RealDetection","Owner","Distance","duration","BulletSpeed","console","log","PlayEffect","BulletResource","startPositionX","positionX","logicPosition","x","startPositionZ","positionZ","z","PlayEffectBulletRealCheck","BulletRealCheck","Name","characterDefine","LogicUpdate","Stoped","UpdateTime","UpdatePos","flyTime","frameTime","Context","Target","isBullet","DoHit2","rockerSpeedVo","Instance","rockerSpeeds","dirDegree","y","dis","Math","floor","GetDistance","RenderToLogic_Value","CastRange","creatureArr","FindUnitsInRange","BulletRadius","teamType2","length","i","creature","hitMap","get","entityId","put","MultipleHit"],"mappings":"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","sourcesContent":["import { Skill } from \"./Skill\";\r\nimport { SkillHitInfo } from \"../Vo/SkillHitInfo\";\r\nimport { Creature } from \"../Enities/Creature\";\r\nimport { NetConfig } from \"../../../Network/NetConfig\";\r\nimport { CreatureManager } from \"../Managers/CreatureManager\";\r\nimport { DataManager } from \"../../../Managers/DataManager\";\r\nimport { LogicRenderConvert } from \"../Utils/LogicRenderConvert\";\r\nimport { MathUtil } from \"../../../Utils/MathUtil\";\r\nimport { HashMap } from \"../../../Utils/HashMap\";\r\nimport { EffectType } from \"../Effects/EffectType\";\r\nimport { EffectController } from \"../Effects/EffectController\";\r\n\r\nexport class Bullet{\r\n       public skill:Skill;\r\n       private hitInfo:SkillHitInfo;\r\n       public duration:number = 0;\r\n       private flyTime:number = 0;\r\n       public positionX:number;  //x位置\r\n       public positionZ:number;  //z位置\r\n       private startPositionX:number;  //开始x位置\r\n       private startPositionZ:number;  //开始z位置\r\n       //已经造成伤害的目标 key=>entintyId  value=>1\r\n       private hitMap=new HashMap(); \r\n\r\n       public Stoped:boolean=false;\r\n       private effect:EffectController;\r\n       private target:Creature;\r\n\r\n        public constructor(skill:Skill, target:Creature, hitInfo:SkillHitInfo)\r\n        {\r\n            this.skill = skill;\r\n            this.hitInfo = hitInfo;\r\n            this.target = target;\r\n            let distance = 0;\r\n            if (!this.skill.Define.RealDetection) {  //非实时检测\r\n                distance = skill.Owner.Distance(target);\r\n                this.duration = distance / this.skill.Define.BulletSpeed;\r\n                //播放特效，子弹朝着目标飞\r\n                console.log('子弹朝着目标飞')\r\n                skill.Owner.PlayEffect(EffectType.Bullet, skill.Define.BulletResource, target, this.duration)\r\n            }else{    //实时检测\r\n                this.startPositionX = this.positionX = skill.Owner.logicPosition.x;\r\n                this.startPositionZ = this.positionZ = skill.Owner.logicPosition.z;\r\n                //播放特效\r\n                skill.Owner.PlayEffectBulletRealCheck(EffectType.BulletRealCheck, skill.Define.BulletResource, this);\r\n            }\r\n            console.log('Bullet：'+this.skill.Define.Name+'，CastBullet：'+this.skill.Define.BulletResource+'，Target：'+(target ? target.characterDefine.Name : '')+'，Distance：'+distance+'，Time：'+this.duration+'，RealDetection：'+this.skill.Define.RealDetection);\r\n        }\r\n\r\n        public LogicUpdate()\r\n        {\r\n            if (this.Stoped) return;\r\n            if (!this.skill.Define.RealDetection)  //非真实检测\r\n            {\r\n                this.UpdateTime();\r\n            }\r\n            else\r\n            {\r\n                this.UpdatePos();\r\n            }\r\n        }\r\n\r\n        private UpdateTime()\r\n        {\r\n            this.flyTime += NetConfig.frameTime;\r\n            if(this.flyTime > this.duration)\r\n            {\r\n                this.skill.Context.Target = this.target; //设置目标\r\n                this.hitInfo.isBullet = true;\r\n                this.skill.DoHit2(this.hitInfo);\r\n                this.Stoped = true;\r\n            }\r\n        }\r\n\r\n        private UpdatePos()\r\n        {\r\n            let rockerSpeedVo = DataManager.Instance.rockerSpeeds[this.skill.Context.dirDegree];\r\n            if(!rockerSpeedVo){\r\n                console.log('Bullet UpdatePos not rockerSpeedVo! dirDegree='+this.skill.Context.dirDegree)\r\n                return;\r\n            }\r\n            this.positionX += (rockerSpeedVo.x * this.skill.Define.BulletSpeed);\r\n            this.positionZ += (rockerSpeedVo.y * this.skill.Define.BulletSpeed);\r\n\r\n            let dis = Math.floor(MathUtil.GetDistance(this.startPositionX, this.startPositionZ, this.positionX, this.positionZ));\r\n            if(dis >= LogicRenderConvert.RenderToLogic_Value(this.skill.Define.CastRange)){  //超出范围则停止\r\n                console.log('超出范围则停止：dis='+dis+'，CastRange='+LogicRenderConvert.RenderToLogic_Value(this.skill.Define.CastRange))\r\n                this.Stoped = true;\r\n                return;\r\n            }\r\n\r\n            let creatureArr = CreatureManager.Instance.FindUnitsInRange(this.positionX, this.positionZ, LogicRenderConvert.RenderToLogic_Value(this.skill.Define.BulletRadius), 1, this.skill.Owner.teamType2);\r\n            if(creatureArr.length > 0){ //打中敌人\r\n               for(let i=0; i < creatureArr.length; i++){\r\n                   let creature = creatureArr[i];\r\n                   if(this.hitMap.get(creature.entityId)){  //已经造成伤害的进入下一次循环\r\n                       continue;\r\n                   }\r\n                   this.hitMap.put(creature.entityId, 1);\r\n\r\n                   this.skill.Context.Target = creature; //设置目标\r\n                   this.hitInfo.isBullet = true;\r\n                   this.skill.DoHit2(this.hitInfo);\r\n                   if(!this.skill.Define.MultipleHit){  //非多次伤害停止\r\n                       this.Stoped = true;\r\n                   }\r\n               }  \r\n            }\r\n        }\r\n}"]}