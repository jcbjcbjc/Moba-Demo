{"version":3,"sources":["file:///D:/LearningFrameWork/MobaYan/Moba/Src/Client/assets/Scripts/UI/Shop/UIShop.ts"],"names":["_decorator","Prefab","Button","UIWindow","EventManager","ListView","UIShopItem","UIShopDetailItem","EventType","TabView","DataManager","MessageBox","ItemService","List","InputBox","Validate","SoundManager","SoundDefine","ccclass","property","UIShop","start","tab","owner","listMain","isAddScene","Instance","addListener","TabView_OnTabSelect","OnTabSelect","ListView_OnItemSelected","OnItemSelected","OnItemBuy_UI","OnItemBuyUI","RefieshUI","param","uiShopItem","console","log","itemDefine","OnClickBuy","Show","buyCountInputObj","input","string","this_","UIInputBox_OnClickYes","count","isIntegerLarge0","SendItemBuy","index","ID","parseInt","Close","PlaySound","SFX_Success","ClearList","InitShop","selectedIndex","shopItemList","shopItems","Object","keys","length","uiShopDetailItem","node","active","i","key","shopItem","Status","push","shopList","numItems","scrollTo","RemoveAll","OnShopListRender","getComponent","AddItem","SetItemInfo","onDestroy","removeListener","removeAll"],"mappings":"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","sourcesContent":["\r\nimport { _decorator, Component, Node, Prefab, instantiate, Button } from 'cc';\r\nimport { UIWindow } from '../Common/UIWindow';\r\nimport { User } from '../../Models/User';\r\nimport { NItem } from '../../../Proto/proto';\r\nimport { EventManager } from '../Common/Event/EventManager';\r\nimport { ListView } from '../Common/ListView/ListView';\r\nimport { UIShopItem } from './UIShopItem';\r\nimport { ListViewItem } from '../Common/ListView/ListViewItem';\r\nimport { UIShopDetailItem } from './UIShopDetailItem';\r\nimport { EventType } from '../Common/Event/EventType';\r\nimport { TabView } from '../Common/TabView/TabView';\r\nimport { DataManager } from '../../Managers/DataManager';\r\nimport { MessageBox, MessageBoxType } from '../Common/MessageBox';\r\nimport { ItemService } from '../../Services/ItemService';\r\nimport List from '../Common/ScrollView/List';\r\nimport { ShopItemDefine } from '../../Data/ShopItemDefine';\r\nimport { InputBox } from '../Common/InputBox';\r\nimport { Validate } from '../../Utils/Validate';\r\nimport { UIInputBox } from '../Common/UIInputBox';\r\nimport { SoundManager } from '../../../Sound/SoundManager';\r\nimport { SoundDefine } from '../../../Sound/SoundDefine';\r\nconst { ccclass, property } = _decorator;\r\n\r\n@ccclass('UIShop')\r\nexport class UIShop extends UIWindow {\r\n\r\n    @property(List)\r\n    private shopList = null as unknown as List;\r\n    @property(TabView)\r\n    public tab: TabView = null as unknown as TabView;\r\n    @property(Prefab)\r\n    public itemPrefab: Prefab = null as unknown as Prefab;\r\n    @property(ListView)\r\n    public listMain: ListView = null as unknown as ListView;\r\n    @property(UIShopDetailItem)\r\n    public uiShopDetailItem = null as unknown as UIShopDetailItem;\r\n    @property(Button)\r\n    public buyButton = null as unknown as Button;  //购买按钮\r\n    public selectedIndex: number = 0;\r\n    private index: number = 0;  //选择索引\r\n\r\n    private uiShopItem: UIShopItem = null as unknown as UIShopItem;\r\n    private shopItemList: Array<ShopItemDefine> = [];\r\n    private buyCountInputObj: UIInputBox;\r\n\r\n    start() {\r\n        this.tab.owner = this;\r\n        this.listMain.owner = this;\r\n        this.listMain.isAddScene = false;\r\n        EventManager.Instance.addListener(EventType.TabView_OnTabSelect, this.OnTabSelect, this);\r\n        EventManager.Instance.addListener(EventType.ListView_OnItemSelected, this.OnItemSelected, this);\r\n        EventManager.Instance.addListener(EventType.OnItemBuy_UI, this.OnItemBuyUI, this);\r\n\r\n        this.RefieshUI();\r\n    }\r\n\r\n    private OnItemSelected(param: any) {\r\n        this.uiShopItem = param[0] as UIShopItem;\r\n        console.log('OnItemSelected=' + this.uiShopItem.itemDefine)\r\n    }\r\n\r\n    /**\r\n     * 点击购买\r\n     */\r\n    public async OnClickBuy() {\r\n        if (!this.uiShopItem) {\r\n            MessageBox.Show(\"请选择要购买的道具\", \"购买提示\");\r\n            return;\r\n        }\r\n        let itemDefine = this.uiShopItem.itemDefine;\r\n        // let confirmObj= await MessageBox.Show(\"确定要购买\"+itemDefine.Name+\"吗？\", \"购买\", MessageBoxType.Confirm,\"确定\",\"取消\"); \r\n        // let this_=this;\r\n        // EventManager.Instance.addListener(EventType.UIMessageBox_OnClickYes,function(){\r\n        //     ItemService.Instance.SendItemBuy(this_.index+1,itemDefine.ID,1);\r\n        // },confirmObj);\r\n        this.buyCountInputObj = await InputBox.Show('请输入购买数量', \"购买\");\r\n        this.buyCountInputObj.input.string = '1'; //默认值\r\n        let this_ = this;\r\n        EventManager.Instance.addListener(EventType.UIInputBox_OnClickYes, function (param: any): string {\r\n            let count = param[0];\r\n            if (!Validate.isIntegerLarge0(count)) {\r\n                return '购买数量必须大于0';\r\n            }\r\n            ItemService.Instance.SendItemBuy(this_.index + 1, itemDefine.ID, parseInt(count));\r\n            return '';\r\n        }, this.buyCountInputObj);\r\n    }\r\n\r\n    /**\r\n     * 购买成功响应\r\n     * @param param \r\n     */\r\n    private OnItemBuyUI(param: any) {\r\n        this.buyCountInputObj.Close();\r\n        SoundManager.Instance.PlaySound(SoundDefine.SFX_Success);\r\n    }\r\n\r\n    public RefieshUI() {\r\n        this.ClearList();\r\n        this.InitShop();\r\n    }\r\n\r\n    /**\r\n    * 切换选择\r\n    * @param param 索引\r\n    */\r\n    private OnTabSelect(param: any) {\r\n        let index = param[0];\r\n        if (this.index == index) {\r\n            return;\r\n        }\r\n        this.index = index;\r\n        this.selectedIndex = 0;\r\n        console.log('OnTabSelect index=' + this.index)\r\n        this.RefieshUI();\r\n    }\r\n\r\n    /**\r\n     * 初始化商店\r\n     */\r\n    public async InitShop() {\r\n        this.shopItemList = [];\r\n        let shopItems = DataManager.Instance.shopItems[this.index + 1];\r\n        if (!shopItems || Object.keys(shopItems).length < 1) {\r\n            this.uiShopDetailItem.node.active = false;\r\n        } else {\r\n            this.uiShopDetailItem.node.active = true;\r\n            let i = 0;\r\n            for (let key in shopItems) {\r\n                let shopItem = shopItems[key];\r\n                if (shopItem.Status > 0) {\r\n                    this.shopItemList.push(shopItem);\r\n                    i++;\r\n                }\r\n            }\r\n        }\r\n        this.shopList.numItems = this.shopItemList.length;\r\n        this.shopList.scrollTo(0);\r\n    }\r\n\r\n    private ClearList(): void {\r\n        this.listMain.RemoveAll();\r\n    }\r\n\r\n    /**\r\n    * 商品列表渲染\r\n    * @param node\r\n    * @param index \r\n    */\r\n    OnShopListRender(node: Node, index: number) {\r\n        let uiShopItem = node.getComponent(UIShopItem);\r\n        this.listMain.AddItem(node, uiShopItem as ListViewItem);\r\n        uiShopItem?.SetItemInfo(this.shopItemList[index], this.uiShopDetailItem, index == this.selectedIndex, index, this);\r\n        // console.log('OnShopListRender index='+index+'，name='+uiShopItem.itemDefine.Name)\r\n    }\r\n\r\n\r\n    onDestroy() {\r\n        console.log('onDestroy')\r\n        this.listMain.removeListener();\r\n        EventManager.Instance.removeAll(this);\r\n    }\r\n\r\n}\r\n"]}