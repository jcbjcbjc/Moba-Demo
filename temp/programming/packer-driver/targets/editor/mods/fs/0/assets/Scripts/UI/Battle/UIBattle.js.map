{"version":3,"sources":["file:///D:/LearningFrameWork/MobaYan/Moba/Src/Client/assets/Scripts/UI/Battle/UIBattle.ts"],"names":["_decorator","Component","Node","instantiate","systemEvent","SystemEvent","Vec2","Label","SpriteFrame","Sprite","SystemEventType","RichText","Prefab","view","director","UITransform","EventManager","proto","proto2","BattleService","EventType","DataManager","TeamType2","MathUtil","BattleManager","RoomService","LocalStorageUtil","BattleGlobal","BattleMode","ChatManager","UILiveMsg","RandomUtil","ccclass","property","FrameHandle","FrameHandleResponse","RepairFrameResponse","TeamType","HeartBeatResponse","ChatChannel","UIBattle","start","windowSize","getCanvasSize","GameOverNode","active","battleMode","Battle","FenSiCountLabel","node","networkSprite","networkLabel","fpsLabel","Live","i","controlActiveNodeArr","length","on","TOUCH_START","OnTouchStart","TOUCH_MOVE","OnTouchMove","TOUCH_END","OnTouchEnd","Instance","addListener","OnHeartBeat_UI","OnHeartBeatUI","ChatUI","LiveChatUI","chatBtnSprite","OnChatClick","OnChat_UI","updateMyChatLastRichText","param","channel","RoomChat","updateLiveChatLastMsg","len","gameMessages","chatMessage","myChatLastRichText","string","getBattleMsgContent","liveMessages","liveMsgStr","liveMsgPoolList","shift","console","log","uiLiveMsg","getComponent","Text","heightRange","height","richText","setPosition","width","limit2","position","getScene","addChild","moveLiveMsgList","push","updateFrameTime","frameTime","index","spriteFrame","networkSpriteFrameArr","Math","floor","frameJgMs","response","liveFenSiCount","e","getStartLocation","startMoveVec2","getLocation","currentMoveVec2","isMoveFlag","isLookAtCharacterFlag","moveTime","Date","getTime","angle","round","GetAngle","y","x","teamType2","currentCharacter","Red","rockerSpeedVo","rockerSpeeds","Blue","abs","cameraPos","camera","worldPosition","speed","vx","vz","z","setWorldPosition","set","isEndFlag","update","handleFrameLabel","handleFrameId","currentTime","lastUpdateTime","jgTime","richTextNode","richTextWidth","contentSize","pos","removeChild","splice","onDestroy","removeAll","OnClickGameOver","SendGameOver","SendGameOver2","OnClickPrintResult","allFrameHandlesStr","GetItem","allFrameHandlesKey"],"mappings":"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","sourcesContent":["\r\nimport { _decorator, Component, Node, instantiate, systemEvent, SystemEvent, Vec2, Vec3, game, v3, Label, SpriteFrame, Sprite, SystemEventType, RichText, Prefab, view, math, director, UITransform } from 'cc';\r\nimport { EventManager } from '../Common/Event/EventManager';\r\nimport proto from '../../../Proto/Battle/proto.js';\r\nimport proto2 from '../../../Proto/proto.js';\r\nimport { OptType } from './enums/OptType';\r\nimport { BattleService } from '../../Services/BattleService';\r\nimport { NetConfig } from '../../Network/NetConfig';\r\nimport { EventType } from '../Common/Event/EventType';\r\nimport { LogUtil } from '../../Log/LogUtil';\r\nimport { HashMap } from '../../Utils/HashMap';\r\nimport { LoadResUtil } from '../../Utils/LoadResUtil';\r\nimport { User } from '../../Models/User';\r\nimport { DataManager } from '../../Managers/DataManager';\r\nimport { CreatureManager } from './Managers/CreatureManager';\r\nimport { TeamType2 } from './enums/TeamType2';\r\nimport { MathUtil } from '../../Utils/MathUtil';\r\nimport { BattleManager } from './Managers/BattleManager';\r\nimport { NetClientBattle } from '../../Network/Battle/NetClientBattle';\r\nimport { RoomService } from '../../Services/RoomService';\r\nimport { LocalStorageUtil } from '../../Utils/LocalStorageUtil';\r\nimport { BattleGlobal } from './Utils/BattleGlobal';\r\nimport { BattleMode } from './enums/BattleMode';\r\nimport { ChatManager } from '../../Managers/ChatManager';\r\nimport { UILiveMsg } from './UILiveMsg';\r\nimport { RandomUtil } from \"./Utils/RandomUtil\";\r\nconst { ccclass, property } = _decorator;\r\nconst {FrameHandle,FrameHandleResponse,RepairFrameResponse }  = proto;\r\nconst {TeamType, HeartBeatResponse,ChatChannel }  = proto2;\r\n\r\n@ccclass('UIBattle')\r\nexport class UIBattle extends Component {\r\n\r\n    @property(Node)\r\n    public GameOverNode:Node=null;   //游戏结束节点\r\n    @property([Node])\r\n    public controlActiveNodeArr=[];   //控制显示、隐藏节点\r\n    @property(Label)\r\n    public FenSiCountLabel:Label=null;   //粉丝数量\r\n    @property([SpriteFrame]) \r\n    public networkSpriteFrameArr:Array<SpriteFrame>=[];    //网络图片集合\r\n    @property(Sprite) \r\n    public networkSprite:Sprite=null;    //网络图片\r\n    @property(Label)\r\n    public networkLabel:Label=null;  //网络文本\r\n    @property(Label)\r\n    public fpsLabel:Label=null;  //fps文本\r\n    @property(Node)\r\n    public ChatUI:Node=null;  //对局聊天ui\r\n    @property(Node)\r\n    public LiveChatUI:Node=null;  //观看直播聊天ui\r\n    @property(Sprite) \r\n    public chatBtnSprite:Sprite=null;    //聊天按钮\r\n    @property(RichText)\r\n    public myChatLastRichText:RichText=null;  //我方最后一次消息\r\n    @property(Prefab)\r\n    public uiLiveMsg:Prefab=null;\r\n    \r\n    @property(Label)\r\n    public handleFrameLabel:Label=null;  //已经处理的帧\r\n\r\n\r\n    private startMoveVec2 = new Vec2();   //开始移动点位置\r\n    private currentMoveVec2 = new Vec2();   //当前移动点位置\r\n    private isMoveFlag = false;  //是否移动\r\n    private moveTime:number = 0;  //移动时间\r\n    private isEndFlag = false;  //是否结束点击\r\n    private lastUpdateTime:number = 0;  //最后帧更新时间\r\n    private frameJgMs:number = 0;  //两帧间隔毫秒数\r\n    private liveMsgPoolList:Array<Node>=[]; //直播消息缓存池\r\n    private windowSize:math.Size=null as unknown as math.Size;\r\n    private moveLiveMsgList:Array<Node>=[];    //移动直播消息集合\r\n\r\n    start () {\r\n        this.windowSize = view.getCanvasSize();\r\n\r\n        this.GameOverNode.active=false;\r\n        \r\n        if(BattleGlobal.battleMode == BattleMode.Battle){    //对局模式\r\n          this.FenSiCountLabel.node.active=true;\r\n          this.networkSprite.node.active=true;\r\n          this.networkLabel.node.active=true;\r\n          this.fpsLabel.node.active=true;\r\n        }else if(BattleGlobal.battleMode == BattleMode.Live){  //观看直播模式\r\n          this.FenSiCountLabel.node.active=false;        \r\n          this.networkSprite.node.active=false; \r\n          this.networkLabel.node.active=false; \r\n          this.fpsLabel.node.active=false; \r\n        } \r\n\r\n        for(let i=0; i < this.controlActiveNodeArr.length; i++){\r\n            let node = this.controlActiveNodeArr[i] as Node;\r\n            if(BattleGlobal.battleMode == BattleMode.Battle){    //对局模式\r\n                node.active=true;\r\n            }else if(BattleGlobal.battleMode == BattleMode.Live){  //观看直播模式\r\n                node.active=false;            \r\n            } \r\n        }\r\n        systemEvent.on(SystemEvent.EventType.TOUCH_START, this.OnTouchStart, this);\r\n        systemEvent.on(SystemEvent.EventType.TOUCH_MOVE, this.OnTouchMove, this);\r\n        systemEvent.on(SystemEvent.EventType.TOUCH_END, this.OnTouchEnd, this);\r\n        EventManager.Instance.addListener(EventType.OnHeartBeat_UI,this.OnHeartBeatUI,this);\r\n \r\n        //我方消息与粉丝消息\r\n        this.ChatUI.active=false;\r\n        this.LiveChatUI.active=false;\r\n        this.chatBtnSprite.node.on(SystemEventType.TOUCH_END,this.OnChatClick,this);\r\n\r\n        //更新我方最后一次消息\r\n        EventManager.Instance.addListener(EventType.OnChat_UI, this.OnChat_UI, this);\r\n        this.updateMyChatLastRichText();\r\n\r\n    }\r\n\r\n    /**\r\n     * 收到消息更新\r\n     * @param param \r\n     */\r\n    private OnChat_UI(param:any){\r\n        let channel = param[0] as ChatChannel;\r\n        if(channel==ChatChannel.RoomChat){  //房间\r\n           this.updateMyChatLastRichText();\r\n           this.updateLiveChatLastMsg();\r\n        } \r\n    }\r\n\r\n    /**\r\n     * 更新我方最后一次消息\r\n     */\r\n    private updateMyChatLastRichText(){\r\n        let len = ChatManager.Instance.gameMessages.length;\r\n        if(len > 0){\r\n          let chatMessage = ChatManager.Instance.gameMessages[len - 1];\r\n          this.myChatLastRichText.string=BattleGlobal.getBattleMsgContent(chatMessage, 50, 0);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 更新直播最后一次消息\r\n     */\r\n    private updateLiveChatLastMsg(){\r\n        let len = ChatManager.Instance.liveMessages.length;\r\n        if(len > 0){\r\n          let chatMessage = ChatManager.Instance.liveMessages[len - 1];\r\n          let liveMsgStr = BattleGlobal.getBattleMsgContent(chatMessage, 50, 1);\r\n          let node:Node=null;\r\n          if(this.liveMsgPoolList.length > 0){\r\n            node=this.liveMsgPoolList.shift()\r\n            console.log('缓存取，剩余len='+this.liveMsgPoolList.length)\r\n          }else{\r\n            node = instantiate(this.uiLiveMsg) \r\n          }\r\n          //设置内容\r\n          let uiLiveMsg = node.getComponent(UILiveMsg);\r\n          uiLiveMsg.Text = liveMsgStr;\r\n          let heightRange = this.windowSize.height/2-30;  //高度正负范围随机\r\n          uiLiveMsg.richText.node.setPosition(this.windowSize.width/2, RandomUtil.limit2(0, heightRange) , 0);\r\n          console.log('直播消息 pos='+uiLiveMsg.richText.node.position)\r\n          director.getScene()?.addChild(node);\r\n          this.moveLiveMsgList.push(node);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 点击聊天\r\n     */\r\n    private OnChatClick(){ \r\n        if(BattleGlobal.battleMode == BattleMode.Battle){    //对局模式\r\n            this.ChatUI.active = !this.ChatUI.active;\r\n        }else if(BattleGlobal.battleMode == BattleMode.Live){  //观看直播模式\r\n            this.LiveChatUI.active = !this.LiveChatUI.active;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 更新间隔帧时间\r\n     * @param frameTime 间隔帧时间\r\n     */\r\n    public updateFrameTime(frameTime:number){\r\n        this.networkLabel.string = frameTime+'ms';\r\n        //设置图标\r\n        let index=0;\r\n        if(frameTime < 80){\r\n            index=5;\r\n        }else if(frameTime >= 80 && frameTime < 90){\r\n            index=4;\r\n        }else if(frameTime >= 90 && frameTime < 100){\r\n            index=3;\r\n        }else if(frameTime >= 100 && frameTime < 110){\r\n            index=2;\r\n        }else if(frameTime >= 110 && frameTime < 120){\r\n            index=1;\r\n        }else if(frameTime >= 120){\r\n            index=0;\r\n        }\r\n        this.networkSprite.spriteFrame = this.networkSpriteFrameArr[index];\r\n        this.fpsLabel.string = 'FPS：' +  Math.floor(1000 / this.frameJgMs);\r\n        console.log('frameJgMs='+this.frameJgMs)\r\n    }\r\n      \r\n    /**\r\n     * 心跳响应\r\n     */\r\n    private OnHeartBeatUI(param: any){\r\n        let response = param[0] as HeartBeatResponse;\r\n        this.FenSiCountLabel.string='粉丝数：'+response.liveFenSiCount;\r\n    }\r\n\r\n    /**\r\n     * 触摸开始\r\n     */\r\n    private OnTouchStart(e){\r\n        e.getStartLocation(this.startMoveVec2);  //开始移动点\r\n\r\n    }\r\n\r\n    /**\r\n     * 触摸移动\r\n     */\r\n    private OnTouchMove(e){\r\n       if(BattleGlobal.battleMode != BattleMode.Live){  //非观看直播模式\r\n         return;\r\n       }\r\n       e.getLocation(this.currentMoveVec2);   //当前移动点\r\n\r\n       this.isMoveFlag = true;  //移动了\r\n       BattleManager.Instance.isLookAtCharacterFlag = false;\r\n\r\n       this.moveTime = new Date().getTime();\r\n\r\n       //控制按钮移动位置\r\n    //    let len=MathUtil.GetDistance(this.startMoveVec2.x, this.startMoveVec2.y, this.currentMoveVec2.x, this.currentMoveVec2.y);\r\n       let angle = Math.round(MathUtil.GetAngle(this.currentMoveVec2.y-this.startMoveVec2.y, this.currentMoveVec2.x-this.startMoveVec2.x));\r\n       let teamType2 = BattleManager.Instance.currentCharacter.teamType2;\r\n       if(teamType2 == TeamType2.Red){  //红队\r\n        angle = 180 - angle;\r\n       }else{\r\n        angle = -angle;\r\n       }\r\n       let rockerSpeedVo = DataManager.Instance.rockerSpeeds[teamType2==TeamType2.Blue ? angle + 180 : Math.abs(angle)];\r\n       if(!rockerSpeedVo){\r\n          console.log('rockerSpeedVo不存在!'+'==='+angle +'=='+(teamType2==TeamType2.Blue ? angle + 180 : Math.abs(angle)))\r\n          return;\r\n       }\r\n       let cameraPos = BattleManager.Instance.camera.worldPosition;\r\n       let speed:number = 2.5;\r\n       let vx=cameraPos.x+((teamType2==TeamType2.Blue ? -1 : 1)*(rockerSpeedVo.x*0.001)*speed);\r\n       let vz=cameraPos.z+((teamType2==TeamType2.Blue ? -1 : 1)*(rockerSpeedVo.y*0.001)*speed);\r\n       BattleManager.Instance.camera.setWorldPosition(vx, cameraPos.y, vz);\r\n\r\n       this.startMoveVec2.set(this.currentMoveVec2.x, this.currentMoveVec2.y);\r\n    }\r\n\r\n    /**\r\n     * 触摸结束\r\n     */\r\n    private OnTouchEnd(e){\r\n        this.isEndFlag = true;\r\n    }\r\n\r\n    update(){\r\n        this.handleFrameLabel.string = '当前逻辑帧数：'+BattleManager.Instance.handleFrameId;\r\n        //计算两帧间隔毫秒数\r\n        let currentTime =  new Date().getTime();\r\n        if(this.lastUpdateTime != 0){\r\n           this.frameJgMs = currentTime - this.lastUpdateTime;\r\n        }\r\n        this.lastUpdateTime = currentTime;\r\n\r\n        //摄像机结束移动后5秒跟随主角\r\n        if(this.isEndFlag && this.isMoveFlag){\r\n          let jgTime = (new Date().getTime() - this.moveTime) / 1000;  //距离最后一次移动间隔时间(s)\r\n          if(jgTime >= 5){  //滑动到角色\r\n            this.isEndFlag = false;\r\n            this.isMoveFlag = false;\r\n            BattleManager.Instance.isLookAtCharacterFlag = true;\r\n          }\r\n        }\r\n\r\n        //移动直播消息\r\n        if(this.moveLiveMsgList.length > 0){\r\n            for(let i=0;i<this.moveLiveMsgList.length;i++){\r\n               let node = this.moveLiveMsgList[i];\r\n               let richTextNode = node.getComponent(UILiveMsg).richText.node;\r\n               let richTextWidth = richTextNode.getComponent(UITransform).contentSize.width;  //文字宽\r\n\r\n               let pos = richTextNode.position;\r\n               let x = pos.x - 1;\r\n               richTextNode.setPosition(x, pos.y, pos.z);\r\n               if(x < -(this.windowSize.width / 2)-richTextWidth){  //超出屏幕\r\n                console.log('超出屏幕移除')\r\n                 director.getScene()?.removeChild(node);\r\n                 this.liveMsgPoolList.push(node);  //回收对象池\r\n                 this.moveLiveMsgList.splice(i, 1); \r\n               }\r\n            }\r\n        }\r\n    }\r\n\r\n    onDestroy(){\r\n        EventManager.Instance.removeAll(this);\r\n    }\r\n\r\n    /**\r\n     * 点击游戏结束\r\n     */\r\n    public OnClickGameOver(){\r\n        BattleService.Instance.SendGameOver();\r\n        RoomService.Instance.SendGameOver2();\r\n        this.GameOverNode.active=true;\r\n    }\r\n\r\n    /**\r\n     * 打印结果\r\n     */\r\n    public OnClickPrintResult(){\r\n        let allFrameHandlesStr = LocalStorageUtil.GetItem(LocalStorageUtil.allFrameHandlesKey);\r\n        console.log(allFrameHandlesStr)\r\n    }\r\n}\r\n"]}