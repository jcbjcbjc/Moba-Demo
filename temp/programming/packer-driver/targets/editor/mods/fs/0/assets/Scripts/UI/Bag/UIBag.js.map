{"version":3,"sources":["file:///D:/LearningFrameWork/MobaYan/Moba/Src/Client/assets/Scripts/UI/Bag/UIBag.ts"],"names":["_decorator","Node","Prefab","UIWindow","User","proto","EventManager","ListView","UIBagItem","UIBagDetailItem","EventType","MessageBox","MessageBoxType","ItemService","InputBox","Validate","ItemManager","List","ccclass","property","NItem","BagHandleType","BagHandleResponse","Result","UIBag","start","listMain","owner","isAddScene","Instance","addListener","ListView_OnItemSelected","OnItemSelected","OnBagHandle_UI","RefieshUI","param","uiBagItem","console","log","ClearList","InitBags","SetUpOpenMode","mode","listenerObj","selectedButton","active","normalNode","bagItems","user","bag","length","uiBagDetailItem","node","bagList","numItems","RemoveAll","OnClickSell","Show","bagHandleType","SELL","confirmObj","define","Name","Confirm","this_","UIMessageBox_OnClickYes","SendBagHandle","ID","OnClickTran","TRAN","confirmTranObj","UIInputBox_OnClickYes","money","isIntegerLarge0","parseInt","OnClickCancelTran","CANCELTRAN","response","result","Success","TranItem","index","CancelTranItem","Close","OnClickSelected","dispatchObj","UIBag_OnClickSelected","OnBagListRender","getComponent","AddItem","SetItemInfo","selectedIndex","onDestroy","removeListener","removeAll"],"mappings":"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","sourcesContent":["\r\nimport { _decorator, Component, Node, Prefab, instantiate } from 'cc';\r\nimport { UIWindow } from '../Common/UIWindow';\r\nimport { User } from '../../Models/User';\r\nimport proto from '../../../Proto/proto.js';\r\nimport { EventManager } from '../Common/Event/EventManager';\r\nimport { ListView } from '../Common/ListView/ListView';\r\nimport { UIBagItem } from './UIBagItem';\r\nimport { ListViewItem } from '../Common/ListView/ListViewItem';\r\nimport { UIBagDetailItem } from './UIBagDetailItem';\r\nimport { EventType } from '../Common/Event/EventType';\r\nimport { MessageBox,MessageBoxType } from \"../Common/MessageBox\";\r\nimport { ItemService } from '../../Services/ItemService';\r\nimport { InputBox } from '../Common/InputBox';\r\nimport { Validate } from '../../Utils/Validate';\r\nimport { ItemManager } from '../../Managers/ItemManager';\r\nimport List from '../Common/ScrollView/List';\r\nimport { UIInputBox } from '../Common/UIInputBox';\r\nconst { ccclass, property } = _decorator;\r\nconst { NItem, BagHandleType, BagHandleResponse, Result } = proto;\r\n\r\n@ccclass('UIBag')\r\nexport class UIBag extends UIWindow {\r\n\r\n    @property(List) \r\n    private bagList = null as unknown as List;\r\n    @property(Prefab)\r\n    public itemPrefab:Prefab=null as unknown as Prefab;\r\n    @property(ListView)\r\n    public listMain:ListView=null as unknown as ListView;\r\n    @property(UIBagDetailItem)\r\n    public uiBagDetailItem=null as unknown as UIBagDetailItem;\r\n    @property(Node)\r\n    public selectedButton=null as unknown as Node;  //选择按钮节点\r\n    @property(Node)\r\n    public normalNode=null as unknown as Node;  //正常打开节点\r\n    public selectedIndex:number=0;\r\n    private uiBagItem:UIBagItem=null as unknown as UIBagItem;\r\n    private bagHandleType:BagHandleType=null as unknown as BagHandleType; \r\n    private money:string='';\r\n    private listenerObj:any;\r\n    private bagItems:Array<NItem> = [];\r\n    private confirmTranObj:UIInputBox = null;\r\n\r\n    start () {\r\n        this.listMain.owner=this;\r\n        this.listMain.isAddScene=false;\r\n        EventManager.Instance.addListener(EventType.ListView_OnItemSelected,this.OnItemSelected,this);\r\n        EventManager.Instance.addListener(EventType.OnBagHandle_UI, this.OnBagHandle_UI, this)\r\n        this.RefieshUI();\r\n    }\r\n\r\n    private OnItemSelected(param:any){\r\n        this.uiBagItem=param[0] as UIBagItem;\r\n        console.log('OnItemSelected='+this.uiBagItem)\r\n    }\r\n    \r\n    public RefieshUI(){\r\n        this.ClearList();\r\n        this.InitBags();\r\n    }\r\n\r\n    /**\r\n     * 设置背包打开方式\r\n     * @param mode 1、正常打开 2、拍卖大厅打开\r\n     */\r\n    public SetUpOpenMode(mode:number=1,listenerObj?:any){\r\n        this.listenerObj = listenerObj ? listenerObj : this;\r\n        if(mode==1){\r\n            this.selectedButton.active=false;\r\n            this.normalNode.active=true;\r\n        }else if(mode==2){\r\n            this.selectedButton.active=true;\r\n            this.normalNode.active=false;\r\n        }\r\n    }\r\n    \r\n    /**\r\n     * 初始化背包\r\n     */\r\n    public InitBags(){\r\n        this.bagItems = User.Instance.user.bag;\r\n        if(!this.bagItems || this.bagItems.length < 1){\r\n            this.uiBagDetailItem.node.active=false;\r\n        }else{\r\n            this.uiBagDetailItem.node.active=true;\r\n        }\r\n        this.bagList.numItems = this.bagItems ? this.bagItems.length : 0;\r\n    }\r\n\r\n    private ClearList():void\r\n    {\r\n        this.listMain.RemoveAll();\r\n    }\r\n\r\n    /**\r\n     * 点击出售\r\n     */\r\n    public async OnClickSell(){\r\n        if (!this.uiBagItem){\r\n            MessageBox.Show(\"请选择要出售的道具\",\"出售\");\r\n            return;\r\n        }\r\n        this.bagHandleType=BagHandleType.SELL;\r\n        let confirmObj= await MessageBox.Show(\"确定要出售\"+this.uiBagItem.define.Name+\"吗？\", \"出售\", MessageBoxType.Confirm,\"确定\",\"取消\"); \r\n        let this_=this;\r\n        EventManager.Instance.addListener(EventType.UIMessageBox_OnClickYes,function(){\r\n           ItemService.Instance.SendBagHandle(this_.uiBagItem.define.ID, this_.bagHandleType, 0);\r\n        },confirmObj);\r\n        \r\n     }\r\n \r\n     /**\r\n      * 点击交易\r\n      */\r\n     public async OnClickTran(){ \r\n        if (!this.uiBagItem){\r\n            MessageBox.Show(\"请选择要交易的道具\",\"交易\");\r\n            return;\r\n        }\r\n       this.bagHandleType=BagHandleType.TRAN;\r\n       this.confirmTranObj= await InputBox.Show('请输入交易金额',\"交易\");\r\n       let this_=this;\r\n       EventManager.Instance.addListener(EventType.UIInputBox_OnClickYes,function(param:any):string{\r\n         this_.money=param[0];\r\n         if(!Validate.isIntegerLarge0(this_.money)){\r\n           return '交易金额必须大于0';\r\n         }\r\n        ItemService.Instance.SendBagHandle(this_.uiBagItem.define.ID, this_.bagHandleType, parseInt(this_.money)); \r\n         return '';\r\n        },this.confirmTranObj);\r\n     }\r\n \r\n     /**\r\n      * 点击取消交易\r\n      */\r\n     public async OnClickCancelTran(){\r\n        if (!this.uiBagItem){\r\n            MessageBox.Show(\"请选择要取消交易的道具\",\"取消交易\");\r\n            return;\r\n        }\r\n       this.bagHandleType=BagHandleType.CANCELTRAN;\r\n       let confirmObj= await MessageBox.Show(\"确定要取消交易\"+this.uiBagItem.define.Name+\"吗？\", \"取消交易\", MessageBoxType.Confirm,\"确定\",\"取消\"); \r\n        let this_=this;\r\n        EventManager.Instance.addListener(EventType.UIMessageBox_OnClickYes,function(){\r\n         ItemService.Instance.SendBagHandle(this_.uiBagItem.define.ID, this_.bagHandleType, 0); \r\n        },confirmObj);\r\n     }\r\n \r\n    private OnBagHandle_UI(param: any){\r\n       let response = param[0] as BagHandleResponse;\r\n       if(response.result == Result.Success){   //成功\r\n           if(this.bagHandleType==BagHandleType.TRAN){  //交易\r\n             ItemManager.Instance.TranItem(this.uiBagItem.index, parseInt(this.money));\r\n           }else if(this.bagHandleType==BagHandleType.CANCELTRAN){  //取消交易\r\n             ItemManager.Instance.CancelTranItem(this.uiBagItem.index);\r\n           }\r\n           this.RefieshUI();\r\n\r\n          if(this.confirmTranObj){\r\n            this.confirmTranObj.Close();\r\n          }\r\n       }\r\n    }\r\n\r\n     /**\r\n     * 点击选择\r\n     */\r\n    public async OnClickSelected(){\r\n        if (!this.uiBagItem){\r\n            MessageBox.Show(\"请选择道具\",\"选择\");\r\n            return;\r\n        }\r\n        EventManager.Instance.dispatchObj(EventType.UIBag_OnClickSelected,this.listenerObj,this.uiBagItem.define.ID);\r\n    }\r\n\r\n     /**\r\n     * 背包列表渲染\r\n     * @param node\r\n     * @param index \r\n     */\r\n    OnBagListRender(node: Node, index: number) {\r\n        let uiBagItem=node.getComponent(UIBagItem);\r\n        this.listMain.AddItem(node,uiBagItem as ListViewItem);\r\n        uiBagItem?.SetItemInfo(this.bagItems[index],this.uiBagDetailItem,index==this.selectedIndex,index,this);\r\n    }\r\n\r\n    onDestroy(){\r\n        console.log('onDestroy')\r\n        this.listMain.removeListener();\r\n        EventManager.Instance.removeAll(this);\r\n    }\r\n\r\n}\r\n"]}