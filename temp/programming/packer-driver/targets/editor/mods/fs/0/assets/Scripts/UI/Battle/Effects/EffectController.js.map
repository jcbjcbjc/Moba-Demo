{"version":3,"sources":["file:///D:/LearningFrameWork/MobaYan/Moba/Src/Client/assets/Scripts/UI/Battle/Effects/EffectController.ts"],"names":["_decorator","Component","Vec3","EffectType","MathUtil","NetConfig","LogicRenderConvert","GlobalPool","ccclass","property","EffectController","Number","onEnable","type","Bullet","BulletRealCheck","this_","setTimeout","node","active","lifeTime","Init","source","target","offset","duration","time","startPos","worldPosition","targetPos","set","x","y","z","console","log","Hit","InitBulletRealCheck","bullet","update","dt","dtms","GetDistance","recoveryThisNode","setWorldPosition","lerp","tempVec3","LogicToRender_Value","positionX","positionZ","frameTime","Stoped","removeFromParent","put","onDestroy"],"mappings":"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","sourcesContent":["import { _decorator, instantiate, Node, Component, Vec3, AnimationComponent, Prefab, UITransform, Vec2, isValid, NodePool } from 'cc';\r\nimport { EffectType } from './EffectType';\r\nimport { HashMap } from '../../../Utils/HashMap';\r\nimport { Bullet } from '../Models/Bullet';\r\nimport { MathUtil } from '../../../Utils/MathUtil';\r\nimport { NetConfig } from '../../../Network/NetConfig';\r\nimport { LogicRenderConvert } from \"../Utils/LogicRenderConvert\";\r\nimport GlobalPool from '../../../Utils/GlobalPool';\r\nconst { ccclass, property } = _decorator;\r\n\r\n@ccclass('EffectController')\r\nexport class EffectController extends Component{\r\n\r\n    @property(Number)\r\n    public lifeTime:number = 1;\r\n    private time:number = 0;\r\n\r\n    private type:EffectType;\r\n    private target:Node;\r\n\r\n    private targetPos:Vec3=new Vec3();\r\n    private startPos:Vec3;\r\n    private offset:Vec3;\r\n    private bullet:Bullet;\r\n\r\n    onEnable()\r\n    {\r\n        if(this.type != EffectType.Bullet && this.type != EffectType.BulletRealCheck)\r\n        {\r\n            let this_ = this;\r\n            setTimeout(function(){\r\n                if(this_.node){\r\n                    this_.node.active = false;\r\n                }\r\n            }, this.lifeTime * 1000)\r\n        }\r\n    }\r\n\r\n    public Init(type:EffectType, source:Node, target:Node, offset:Vec3, duration:number)\r\n    {\r\n        this.type = type;\r\n        this.target = target;\r\n        if(duration > 0)\r\n          this.lifeTime = duration;\r\n        this.time = 0;\r\n        if (type == EffectType.Bullet)\r\n        {\r\n            this.startPos = this.node.worldPosition;\r\n            this.offset = offset;\r\n            this.targetPos.set(target.worldPosition.x + offset.x, target.worldPosition.y + offset.y, target.worldPosition.z + offset.z);\r\n            console.log('EffectController Init targetPos='+this.targetPos)\r\n        }\r\n        else if(type==EffectType.Hit)\r\n        {\r\n            this.node.worldPosition = new Vec3(target.worldPosition.x + offset.x, target.worldPosition.y + offset.y, target.worldPosition.z + offset.z);\r\n        }\r\n    }\r\n\r\n    public InitBulletRealCheck(type:EffectType, bullet:Bullet){\r\n        this.type = type;\r\n        this.bullet = bullet;\r\n       \r\n    }\r\n\r\n    private tempVec3 = new Vec3();\r\n    update(dt:number)\r\n    {\r\n        let dtms = dt * 1000;\r\n        if (this.type == EffectType.Bullet) {\r\n            this.time += dtms;\r\n            if(this.target)\r\n            {\r\n                this.targetPos.set(this.target.worldPosition.x + this.offset.x, this.target.worldPosition.y + this.offset.y, this.target.worldPosition.z + this.offset.z); \r\n            }\r\n            // this.node.lookAt(this.targetPos);\r\n            // if(Vec3.distance(this.targetPos,this.node.worldPosition) < 0.5)\r\n            if(MathUtil.GetDistance(this.targetPos.x, this.targetPos.z, this.node.worldPosition.x, this.node.worldPosition.z) < 0.5)\r\n            {\r\n                console.log('回收子弹')\r\n                this.recoveryThisNode();\r\n                return;\r\n            }\r\n            if(this.lifeTime >0 && this.time >= this.lifeTime)\r\n            {\r\n                console.log('回收子弹')\r\n                this.recoveryThisNode();\r\n                return;\r\n            }\r\n            this.node.setWorldPosition(Vec3.lerp(this.node.worldPosition, this.node.worldPosition, this.targetPos, dtms / (this.lifeTime - this.time)));\r\n            // this.node.setWorldPosition(MathUtil.lerp(this.node.worldPosition, this.targetPos, dtms, dtms / (this.lifeTime - this.time)));\r\n        } else if (this.type == EffectType.BulletRealCheck) {  //子弹实时检测\r\n            this.tempVec3.set(LogicRenderConvert.LogicToRender_Value(this.bullet.positionX), this.node.worldPosition.y, LogicRenderConvert.LogicToRender_Value(this.bullet.positionZ));\r\n            this.node.setWorldPosition(MathUtil.lerp(this.node.worldPosition, this.tempVec3, dtms, NetConfig.frameTime));\r\n            if(this.bullet.Stoped){\r\n              this.recoveryThisNode();  \r\n              console.log('EffectController BulletRealCheck Stoped destroy')\r\n              return;\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 回收当前节点\r\n     */\r\n    private recoveryThisNode(){\r\n        this.node.removeFromParent();  // 将节点从父亲节点移除\r\n        GlobalPool.put(this.node);  //回收到对象池\r\n    } \r\n\r\n    onDestroy(){\r\n        console.log('EffectController onDestroy')\r\n    }\r\n\r\n\r\n}"]}