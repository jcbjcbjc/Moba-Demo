{"version":3,"sources":["file:///D:/LearningFrameWork/MobaYan/Moba/Src/Client/assets/Scripts/UI/Chat/UIChatItem.ts"],"names":["_decorator","Node","Label","SystemEventType","ListViewItem","User","proto","EventManager","UIOtherMyUserItem","ChatManager","ccclass","property","NItem","ChatMessage","ChatChannel","UIChatItem","onLoad","node","on","TOUCH_END","OnPointerClick","SetItemInfo","chatMessage","enterFontCount","index","chatChannel","chatMessageList","timeNode","active","uiOtherMyUserItem","fromId","Instance","user","id","myUser","otherUser","getComponent","isShowTime","console","log","prevCompMessage","Comp","compMessages","Private","RoomChat","roomMessages","jgTime","time","timeLabel","string","Date","parseInt","toWeiXinString","onDestroy","removeAll"],"mappings":"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","sourcesContent":["import { ListViewItem } from \"../Common/ListView/ListViewItem\";\r\n\r\nimport { _decorator, Component, Node, Prefab, Label, Sprite, SystemEventType, SpriteFrame } from 'cc';\r\nimport { UIWindow } from '../Common/UIWindow';\r\nimport { User } from '../../Models/User';\r\nimport proto from '../../../Proto/proto.js';\r\nimport { EventManager } from \"../Common/Event/EventManager\";\r\nimport { ListView } from \"../Common/ListView/ListView\";\r\nimport { DataManager } from \"../../Managers/DataManager\";\r\nimport { LoadResUtil } from \"../../Utils/LoadResUtil\";\r\nimport { UIChat } from \"./UIChat\";\r\nimport { ShopItemDefine } from \"../../Data/ShopItemDefine\";\r\nimport { ItemDefine } from \"../../Data/ItemDefine\";\r\nimport { UIOtherMyUserItem } from \"./UIOtherMyUserItem\";\r\nimport { ChatManager } from \"../../Managers/ChatManager\";\r\nconst { ccclass, property } = _decorator;\r\nconst { NItem, ChatMessage, ChatChannel } = proto;\r\n\r\n@ccclass('UIChatItem')\r\nexport class UIChatItem extends ListViewItem {\r\n\r\n    @property(Node)\r\n    public otherUser=null as unknown as Node;\r\n    @property(Node)\r\n    public myUser=null as unknown as Node;\r\n    @property(Node)\r\n    public timeNode=null as unknown as Node;\r\n    @property(Label)\r\n    public timeLabel=null as unknown as Label;\r\n\r\n\r\n    onLoad () {\r\n      this.node.on(SystemEventType.TOUCH_END,this.OnPointerClick,this);\r\n    }\r\n\r\n\r\n    public async SetItemInfo(chatMessage:ChatMessage,enterFontCount:number, index: number, chatChannel:ChatChannel, chatMessageList?: any){\r\n      this.timeNode.active=false;\r\n      if(!chatMessage){\r\n        return;\r\n      }\r\n      let uiOtherMyUserItem=null;\r\n      if(chatMessage.fromId==User.Instance.user.id){\r\n        this.myUser.active=true;\r\n        this.otherUser.active=false;\r\n        uiOtherMyUserItem=this.myUser.getComponent(UIOtherMyUserItem);\r\n      }else{\r\n        this.myUser.active=false;\r\n        this.otherUser.active=true;\r\n        uiOtherMyUserItem=this.otherUser.getComponent(UIOtherMyUserItem);\r\n      }\r\n      uiOtherMyUserItem?.SetItemInfo(chatMessage,enterFontCount);\r\n\r\n      //判断时间是否显示\r\n      let isShowTime:boolean=false;\r\n      if(index-1 < 0){  //第一个显示\r\n        isShowTime=true;\r\n      }else{  //与上一条聊天的时间间隔\r\n        console.log('chat Type='+chatChannel)\r\n        let prevCompMessage;\r\n        if(chatChannel==ChatChannel.Comp){  //综合\r\n            prevCompMessage=ChatManager.Instance.compMessages[index-1];\r\n        }else if(chatChannel==ChatChannel.Private){  //私聊\r\n            prevCompMessage=chatMessageList[index-1];\r\n        }else if(chatChannel==ChatChannel.RoomChat){  //房间\r\n            prevCompMessage=ChatManager.Instance.roomMessages[index-1];\r\n      }\r\n        if(prevCompMessage){\r\n          let jgTime=chatMessage.time-prevCompMessage.time;\r\n          if(jgTime > 3*60*1000){\r\n            isShowTime=true;\r\n          }\r\n        }\r\n      }\r\n      if(isShowTime){\r\n        this.timeNode.active=true;\r\n        console.log('chatMessage.time='+chatMessage.time)\r\n        this.timeLabel.string=new Date(parseInt(chatMessage.time)).toWeiXinString();\r\n      }\r\n    }\r\n\r\n\r\n    onDestroy(){\r\n        console.log('onDestroy')\r\n        EventManager.Instance.removeAll(this);\r\n    }\r\n}"]}