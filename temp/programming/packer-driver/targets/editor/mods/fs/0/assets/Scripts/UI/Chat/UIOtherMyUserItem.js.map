{"version":3,"sources":["file:///D:/LearningFrameWork/MobaYan/Moba/Src/Client/assets/Scripts/UI/Chat/UIOtherMyUserItem.ts"],"names":["_decorator","Component","Label","Sprite","RichText","Layout","UITransform","SystemEventType","proto","LoadResUtil","DataManager","UIManager","ccclass","property","ChatMessage","UIOtherMyUserItem","start","avatarSprite","node","on","TOUCH_END","avatarClick","SetItemInfo","chatMessage","enterFontCount","fromCCharacterId","userId","fromId","levelLabel","string","fromLevel","nickNameLabel","fromName","spriteFrame","load_local_sprite","Instance","characters","Avatar","toCCharacterId","toId","toLevel","toName","contentRichText","getContent","msg","offset","bubbleNode","getChildByName","bubbleLayout","getComponents","updateLayout","bubbleUt","getComponent","itemUt","parent","height","getPosition","y","contentStr","tempStr","startFlag","endFlag","i","char","chatIconId","replace","console","log","uiCharacterDetail","show","SendCharacterDetail"],"mappings":"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","sourcesContent":["\r\nimport { _decorator, Component, Node, Label, Sprite, RichText, Layout, UITransform, SystemEventType } from 'cc';\r\nimport proto from '../../../Proto/proto.js';\r\nimport { LoadResUtil } from '../../Utils/LoadResUtil';\r\nimport { User } from '../../Models/User';\r\nimport { DataManager } from '../../Managers/DataManager';\r\nimport { UIManager } from '../Common/UIManager';\r\nimport { UICharacterDetail } from '../UICharacterDetail/UICharacterDetail';\r\nconst { ccclass, property } = _decorator;\r\nconst { ChatMessage } = proto;\r\n\r\n@ccclass('UIOtherMyUserItem')\r\nexport class UIOtherMyUserItem extends Component {\r\n \r\n    @property(Sprite)\r\n    public avatarSprite=null as unknown as Sprite;\r\n    @property(Label)\r\n    public levelLabel=null as unknown as Label;\r\n    @property(Label)\r\n    public nickNameLabel=null as unknown as Label;\r\n    @property(RichText)\r\n    public contentRichText=null as unknown as RichText;\r\n\r\n    private chatMessage=null as unknown as ChatMessage;\r\n    private userId:number; \r\n\r\n    start () {\r\n        this.avatarSprite.node.on(SystemEventType.TOUCH_END, this.avatarClick,this);\r\n    }\r\n\r\n    public async SetItemInfo(chatMessage:ChatMessage,enterFontCount:number){\r\n        // console.log(this.chatMessage && this.chatMessage.fromId==chatMessage.fromId && this.chatMessage.time==chatMessage.time)\r\n        // if(this.chatMessage && this.chatMessage.fromId==chatMessage.fromId && this.chatMessage.time==chatMessage.time){\r\n        //     return;\r\n        // }\r\n        this.chatMessage=chatMessage;\r\n        if(chatMessage.fromCCharacterId){\r\n            this.userId=chatMessage.fromId;\r\n            this.levelLabel.string='lv'+chatMessage.fromLevel;\r\n            this.nickNameLabel.string=chatMessage.fromName;\r\n            this.avatarSprite.spriteFrame=await LoadResUtil.load_local_sprite(DataManager.Instance.characters[chatMessage.fromCCharacterId].Avatar+'/spriteFrame');\r\n        }else if(chatMessage.toCCharacterId){\r\n            this.userId=chatMessage.toId;\r\n            this.levelLabel.string='lv'+chatMessage.toLevel;\r\n            this.nickNameLabel.string=chatMessage.toName;\r\n            this.avatarSprite.spriteFrame=await LoadResUtil.load_local_sprite(DataManager.Instance.characters[chatMessage.toCCharacterId].Avatar+'/spriteFrame');\r\n        }\r\n        \r\n        this.contentRichText.string=this.getContent(chatMessage.msg,enterFontCount);\r\n    \r\n        //动态计算聊天item高度\r\n        let offset: number = 60;\r\n        let bubbleNode=this.node.getChildByName('bubbleSprite');   //弹幕背景\r\n        let bubbleLayout: Layout = bubbleNode.getComponents(Layout)[1];  //弹幕布局组件\r\n        bubbleLayout.updateLayout();\r\n        let bubbleUt: UITransform = bubbleNode.getComponent(UITransform);  //弹幕变换组件\r\n        let itemUt=this.node.parent.getComponent(UITransform);  //item\r\n        itemUt.height=bubbleNode.getPosition().y+bubbleUt.height+offset;  //更新item高度\r\n        // console.log('item height：'+itemUt.height+'，'+bubbleNode.getPosition().y+'，'+bubbleUt.height)\r\n    }\r\n\r\n    /**\r\n     * 获取文本内容\r\n     * @param msg \r\n     */\r\n    public getContent(msg:string,enterFontCount:number):string{\r\n        let contentStr='';\r\n        let tempStr='';\r\n        let startFlag=false;\r\n        let endFlag=false;\r\n        let i=0;\r\n        for(let char of msg){\r\n            i++;\r\n            if(i%enterFontCount==0){  //换行\r\n                char += '\\n';\r\n            }\r\n            if(char=='['){\r\n                startFlag=true;\r\n            }\r\n            if(char==']'){\r\n                endFlag=true;\r\n            }\r\n            if(startFlag || endFlag){\r\n                tempStr += char;\r\n            }\r\n            if(startFlag && endFlag){\r\n                startFlag=endFlag=false;\r\n                //替换表情\r\n                let chatIconId=tempStr.replace('[','').replace(']','');\r\n                contentStr += \"<img src='\"+chatIconId+\"' width=32 height=32 />\";\r\n                tempStr = '';\r\n                continue;\r\n            }\r\n            if(startFlag || endFlag){\r\n                continue;            \r\n            }\r\n            contentStr += char;\r\n        }\r\n        contentStr += tempStr;\r\n        // console.log('contentStr='+contentStr)\r\n        return '<color=#000000>'+contentStr+'</color>';\r\n    }\r\n    \r\n\r\n    /**\r\n     * 头像点击\r\n     */\r\n    private async avatarClick(){\r\n        console.log('avatarClick')\r\n        let uiCharacterDetail = await UIManager.Instance.show(\"UICharacterDetail\") as UICharacterDetail;\r\n        uiCharacterDetail.SendCharacterDetail(this.userId, 0, 2);\r\n      }\r\n}\r\n"]}